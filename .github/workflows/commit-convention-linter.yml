name: PR Commit Convention Linter

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write

jobs:
  commit-lint:
    runs-on: ubuntu-latest

    steps:
      - name: Minimal Git clone without actions/checkout
        run: |
          git init
          git remote add origin https://github.com/${{ github.repository }}.git
          git fetch origin ${{ github.event.pull_request.head.ref }} --depth=1
          git checkout FETCH_HEAD

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Get latest commit message
        id: get_commit
        run: |
          git log -1 --pretty=format:"%s" > commit.txt

      - name: Validate commit message
        id: validate
        run: |
          line=$(cat commit.txt)
          echo "Checking commit: $line"
          if ! [[ "$line" =~ ^(Feat|Fix|Docs|Style|Refactor|Test|Chore|Ci|Perf|Build)(\(.+\))?:\ .+ ]] && ! [[ "$line" =~ ^Merge.* ]]; then
            echo "::error::❌ Invalid commit message: $line"
            echo "invalid=1" >> $GITHUB_OUTPUT
          else
            echo "invalid=0" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR if invalid
        if: steps.validate.outputs.invalid == '1'
        run: |
          gh pr comment "$PR_NUMBER" --body "🚫 One or more commit messages in this PR **do not follow the commit convention.**

          Please revise them to match the format: \`Feat(component): message\`

          📘 See our [Wiki](https://github.com/khyeonm/2025_Advanced_Programming/wiki/Git-Commit-Convention) for details.

          Thank you!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
